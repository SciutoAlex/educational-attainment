
<!DOCTYPE html>
<meta charset="utf-8">

<script type="text/javascript" src="//use.typekit.net/vwe0ulk.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

<style>

html {
  font-size:10px;
  font-family:"museo-sans";
}

body {
  background:#fffcf4;
}

.container {
  width:1050px;
  margin:0px auto;
}

.sidebar {
  float:right;
  width:340px;
}


/*SIDEBAR*/

.sidebar {
  margin-top:50px;
}
h1 {
  font-family: "museo-slab";
  font-size:3rem;
  margin:3px 0;

}

.top {
  padding: 20px 40px 10px 40px;
  border-bottom:1px solid black;
}

.top p {
margin: 3px 0;
font-size: 1.6rem;
line-height: 2.3rem;
}

.searchbar {
  background: url('img/find.png') right center no-repeat;
  background-size:15px;
}
.twitter-typeahead {
  font-size:2rem;
}
.twitter-typeahead input {
  background: transparent;
  border: none;
  border-bottom: 1px solid black;
  width: 340px;
  font-size: 2rem;
  font-family: "museo-sans";
  padding: 3px;
}

.twitter-typeahead .tt-dropdown-menu {
  font-size:1.2rem;
  background:white;
  width:100%;
  -webkit-box-shadow: 0px 0px 10px 0px rgba(0,0,0,.1);
-moz-box-shadow: 0px 0px 10px 0px rgba(0,0,0,.1);
box-shadow: 0px 0px 10px 0px rgba(0,0,0,.1);
}

.tt-dropdown-menu .tt-suggestion p {
  padding:6px 3px;
  margin:0;
}
.tt-cursor {
  cursor:pointer;
  background-color: #d5cbb8;
}



.axes line {
  stroke-width: 1px;
stroke: black;
}

.bars .bar {
  stroke-width:3px;
}

.stat {
  float:left;
  width:30%;
  margin-right:5%;
  text-align:center;
}

.stat:last-child {
  margin-right:0px;
}

.stat p {
  font-weight:700;
  font-size:1.1rem;
  margin-bottom:3px;
  margin-top:3px;
}

.stat div {
  font-weight:100;
  font-size:3rem;
}

.name {
  width: 300px;
font-size: 2rem;
font-family: "museo-sans";
padding: 3px;
}

.hovered {
  color:#888;
}

.buttons {
  border-top: 1px solid;
margin-top: 40px;
font-size: 1.3rem;
font-weight:bold;
}

.buttons a {
  text-decoration:none;
}

.buttons a {
  padding-top:10px;
  display:inline-block;
  text-align:center;
  width:29%;
  margin-right:5%;
}

.buttons a.featured{
  border-top:3px solid black;
}

.buttons a:last-child {
  margin-right:0;
}

.featured div, .featured p {
  font-weight:900;
}


/*SVG STYLES*/
path {
  fill:#fff;
  fill-opacity:.001;
  stroke:none;
}

.land {
  fill: #fff;
  fill-opacity:1;
}

.border {
  fill: none;
  stroke: #faf4e5;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.bubble {
  fill-opacity: .3;
  stroke-width: .5px;
}

.grad {
  fill: #68b16d;
  stroke: #68b16d;
}

.hs {
  fill: #d09654;
  stroke:  #d09654;
}

.counties .hovered {
  stroke:#c4c58d;
  stroke-width:1px;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.counties .selected {
  stroke:#32322c;
  stroke-width:2px;
  stroke-linejoin: round;
  stroke-linecap: round;
}





</style>
<body>

<div class="container">
  <div class="top">
    <h1>Educational Attainment Across the Country</h1>
    <p>
      Educational attainment—the highest educational level a person achieves—varies across the country. Some counties are rich in people with professional and advanced degrees. Other counties are mostly filled with people who only finished high school. Education levels greatly affect the economic, social, and cultural life of a county.
    </p>
    <p>
      Below is a map showing three different levels of educational attainment: high school, bachelors, and graduate levels. The map shows the proportion of residents over the age of 25 who have achieved a certain level of education. Green circles represent counties that have greater proportions of that educational achievement. Red circles represent counties with a smaller proportion of that educational achievement.
    </p>
  </div>
  <svg class="map"></svg>
  <div class="sidebar">
    <div class="searchbar">
      <input type="text" class="typeahead" value="">
    </div>
    <div class="selected county">
      <div class="stats">
        <div class="stat">
          <p>Graduate/Professional</p>
          <div>4.5%</div>
        </div>
        <div class="stat">
          <p>Bachelors</p>
          <div>4.5%</div>
        </div>
        <div class="stat">
          <p>High School</p>
          <div>4.5%</div>
        </div>
      </div>
    </div>
    <svg class="histogram"></svg>
    <div class="hovered county">
      <div class="stats">
        <div class="stat">
          <div>4.5%</div>
          <p>Graduate/Professional</p>
        </div>
        <div class="stat">
          <div>4.5%</div>
          <p>Bachelors</p>
        </div>
        <div class="stat">
          <div>4.5%</div>
          <p>High School</p>
        </div>
      </div>
      <div style="clear:both;"></div>
      <div class="name">St. Louis City, Missouri</div>
    </div>
    <div class="buttons">
      <a href="#" class="button" data-series = "graduatePercent">Graduate Proportion</a>

      <a href="#" class="button featured" data-series = "bachelorPercent">Bachelors Proportion</a>
      <a href="#" class="button" data-series = "hsPercent">High School Proportion</a>
    </div>
  </div>
</div>


<script src="js/main.js"></script>
<script>

var width = 700,
    height = 425;

var histWidth = 340,
    histHeight = 100;

var path = d3.geo.path()
    .projection(null);

var svg = d3.select(".map")
    .attr("width", width)
    .attr("height", height);

var svgHist = d3.select('.histogram')
    .attr("width", histWidth)
    .attr("height", histHeight);

var histWidthScale, histHeighScale, histogramJoin, circleJoin;
var data;

var radius = d3.scale.sqrt()
    .domain([0, 100])
    .range([1, 8]);

var red = "#4aa738",
    green = "#b64a02"
    gray = "#333";

var series = "bachelorPercent";


//Initialize the typeahead engine
//==========
var engine = new Bloodhound({
  local : [],
  name: 'search',
  limit: 30,
  datumTokenizer: function(d) {
    return Bloodhound.tokenizers.whitespace(d.name);
  },
  queryTokenizer: Bloodhound.tokenizers.whitespace
});

engine.initialize();

var countyTypeAhead = $('.typeahead').typeahead({
  minLength: 3,
  highlight: true,
  hint: false
},
{
  name: 'my-dataset',
  source: engine.ttAdapter(),
  displayKey : "name"
})
.focus(function() {
  $(this).val("");
});

countyTypeAhead.on('typeahead:selected', function(e, data, datasetName) {
  var functionToFire = $.proxy( refreshMap, data.context );
  functionToFire(data.data);
});


//Connect Button Event
//============
$('.button').click(function() {
  changeSeries($(this).attr('data-series'));
  $(this).siblings().removeClass('featured');
  $(this).addClass('featured')
});


d3.json("us.json", function(error, us) {
  if (error) return console.error(error);


  //Create the histogram
  //=========

  data = topojson.feature(us, us.objects.counties).features;
  var binNumber = 60;
  var dataHistogram = d3.layout.histogram()
    .value(function(d) { return d.properties[series]; })
    .bins(binNumber)
    (topojson.feature(us, us.objects.counties).features);


  topojson.feature(us, us.objects.counties).features.map(function(d) {
    d.properties.bin = binIndex(d, dataHistogram);
  });


  histHeightScale = d3.scale.linear()
      .domain([0, 500])
      .range([0, histHeight-40]);

  histWidthScale = d3.scale.linear()
      .domain(d3.extent(topojson.feature(us, us.objects.counties).features, function(d) { return d.properties[series]}))
      .range([0, histWidth]);

  svgHist.append('g')
    .attr('class', 'bars')
    .attr('transform', 'translate(0, 20)');

  histogramJoin = svgHist.select('.bars').selectAll('.bar')
    .data(dataHistogram)
  .enter().append('rect')
    .attr('class', 'bar')
    .attr('width', parseInt(histWidth/binNumber - 1))
    .attr('height', function(d) {
      if(d.y != 0) {
        return histHeightScale(d.y)+1;
      } else {
        return histHeightScale(d.y);
      }
    })
    .attr('y', function(d) {
      if(d.y != 0) {
        return histHeight-40 - histHeightScale(d.y)-1;
      } else {
        return histHeight-40 - histHeightScale(d.y);
      }
    })
    .attr('x', function(d, i) { return histWidthScale(d.x); });


  var axes = svgHist.append('g')
    .attr('class', 'axes');

  axes.selectAll('.labels')
    .data(d3.extent(topojson.feature(us, us.objects.counties).features, function(d) {return d.properties[series]; }))
    .enter()
      .append('text')
        .text(function(d) { return d + "%";})
        .attr('x', function(d) { return histWidthScale(d)})
        .attr('y', histHeight-8)
        .attr('text-anchor', function(d,i) {
          if(i == 0) {
            return "start";
          } else {
            return "end";
          }
        });
  axes.append('line')
    .attr('y1' , histHeight-19)
    .attr('y2', histHeight-19)
    .attr('x1', 0)
    .attr('x2', histWidth);


  svgHist.append('g')
    .attr('class', 'markers')
    .append('circle')
      .attr('class', 'selected-marker')
      .attr('r', 2)
      .attr('cy', 10);

  svgHist.select('.markers')
    .append('circle')
      .attr('class', 'hover-marker')
      .attr('r', 2)
      .attr('cy', histHeight-5);


  //Create the Key
  //==================

  svg.append('g')
    .attr('class', 'legend')
    .attr('transform', 'translate(410, 385)')
    .selectAll('circles')
    .data([30, 15, 3, 15, 30])
    .enter()
    .append('circle')
    .attr('r', function(d) {return radius(d); })
    .attr('cx', function(d,i) { return i*15; })
    .style("fill", function(d, i) {
      var returnVal = "";
      if(i < 2) {
        returnVal = green;
      } else if ( i > 2) {
        returnVal = red;
      } else {
        returnVal = gray;
      }
      return returnVal;
    })
    .style("fill-opacity", function(d, i) {
      var returnVal = "";
      if(i == 2) {
        returnVal = 1;
      } else {
        returnVal = .3;
      }
      return returnVal;
    })
    .style("stroke", function(d,i) {
      var returnVal = "";
      if(i < 2) {
        returnVal = green;
      } else if (i > 2) {
        returnVal = red;
      } else {
        returnVal = gray;
      }
      return returnVal;
    });

  svg.select('.legend').append('text').text('less proportion').attr('x', 10).attr('text-anchor', 'middle');
  svg.select('.legend').append('text').text('equal proportion').attr('x', 30).attr('text-anchor', 'middle');
  svg.select('.legend').append('text').text('greater proportion').attr('x', 50).attr('text-anchor', 'middle');





  //Create the Map
  //=====================
  svg.append("path")
      .datum(topojson.feature(us, us.objects.nation))
      .attr("class", "land")
      .attr("d", path);

  svg.append("path")
      //.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .datum(topojson.mesh(us, us.objects.states))
      .attr("class", "border border--state")
      .attr("d", path);

  circleJoin = svg.append("g")
    .attr("class", "bubble grad")
  .selectAll("circle")
    .data(topojson.feature(us, us.objects.counties).features
      .sort(function(a, b) { return b.properties[series] - a.properties[series]; }))
  .enter().append("circle")
    .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
    .attr("r", function(d) { return radius(d.properties[series]); })
    .attr("data-name" , function(d) { return d.properties.name; });


  svg.append("g")
      .attr("class", "counties")
    .selectAll("counties")
      .data(topojson.feature(us, us.objects.counties).features)
    .enter().append('path')
      .attr("d", path)
      .on('mouseover', hoverMap)
      .on('mouseout', function() {
        d3.select(this).classed("hovered", false);
      })
      .on('click', refreshMap)
      .each(addCountyToTypeAhead)
      .each(function(d) {
        if(d.properties.hsPercent > 100) {
          console.log(d.properties);
        }
      });

    $('.counties path').eq(45).d3Click();

});



  //Add histogram bins to the data pieces
  //==========
  function binIndex(d, hist) {
      var dataToBin = d.properties[series];
      var returnVal = 0;
      hist.map(function(d,i) {
        var ceil = d.x + d.dx;
        var floor = d.x;
        if(dataToBin > floor && dataToBin < ceil) {
          returnVal = i;
        }
      })
      return returnVal;
  }

  //Function called for each county to add counties to typeahead
  //==========
  function addCountyToTypeAhead(d) {
    if(d.properties.name) {
      engine.add({
        "name" : d.properties.name,
        "context" : this,
        "data" : d
      });
    }
  }


  //Function to change when hovering
  //=======

  function hoverMap(d) {
    d3.select(this).classed("hovered", true);

    currentData = d;

    var hsPercent = d.properties.hsPercent;
    var gradPercent = d.properties.graduatePercent;
    var bachelorPercent = d.properties.bachelorPercent;
    var basePercent;
    if(series == "graduatePercent") {
      basePercent = gradPercent;
    } else if(series == "bachelorPercent"){
      basePercent = bachelorPercent;
    }else if(series == "hsPercent"){
      basePercent = hsPercent;
    }
    var currentBin = d.properties.bin;



    svgHist.select('.markers').select('.hover-marker')
      .transition().duration(500)
        .attr('transform', 'translate('+ histWidthScale(basePercent) +','+ 0 +')');

    var stats = $('.hovered .stat div');
    stats.eq(0).html(gradPercent + "%");
    stats.eq(1).html(bachelorPercent + "%");
    stats.eq(2).html(hsPercent + "%");
    $('.hovered .name').html(d.properties.name);


  }

  //Function to change the map based on county selected
  //this =
  //==========
  var currentContext, currentData, currentBin;
  function refreshMap(d) {

    if(this !== window) {
      currentContext = this;
    }
    var hsPercent = d.properties.hsPercent;
    var gradPercent = d.properties.graduatePercent;
    var bachelorPercent = d.properties.bachelorPercent;
    currentBin = d.properties.bin;

    var basePercent;
    if(series == "graduatePercent") {
      basePercent = gradPercent;
    } else if(series == "bachelorPercent"){
      basePercent = bachelorPercent;
    }else if(series == "hsPercent"){
      basePercent = hsPercent;
    }


    //add the selected class to the selected path
    d3.selectAll(".counties path").classed("selected", false);
    d3.select(currentContext).classed("selected", true);

    //Modify all the circles
    svg.select(".grad").selectAll('circle')
      .sort(function(a, b) { return b.properties[series] - a.properties[series]; })
      .transition()
      .duration(500)
      .attr("r", function(d) { return radius(Math.abs(basePercent - d.properties[series])); })
      .style("fill", function(d) {
        var returnVal = "";
        if(d.properties.bin < currentBin) {
          returnVal = green;
        } else if ( d.properties.bin > currentBin) {
          returnVal = red;
        } else {
          returnVal = gray;
        }
        return returnVal;
      })
      .style("fill-opacity", function(d) {
        var returnVal = "";
        if(d.properties.bin == currentBin) {
          returnVal = 1;
        } else {
          returnVal = .3;
        }
        return returnVal;
      })
      .style("stroke", function(d) {
        var returnVal = "";
        if(d.properties.bin < currentBin) {
          returnVal = green;
        } else if ( d.properties.bin > currentBin) {
          returnVal = red;
        } else {
          returnVal = gray;
        }
        return returnVal;
      })


      //Update the histogram
      svgHist.select('.markers').select('.selected-marker')
        .transition().duration(500)
          .attr('transform', 'translate('+ histWidthScale(basePercent) +','+ 0 +')');

      console.log(currentBin)
      //And update histogram colors
      histogramJoin
        .transition().duration(500)
          .style("fill", function(d, i) {
            var returnVal = "";
            if(i < currentBin) {
              returnVal = green;
            } else if ( i > currentBin) {
              returnVal = red;
            } else {
              returnVal = "black";
            }
            return returnVal;
          });

      //Update Sidebar
      var stats = $('.selected .stat div');
      stats.eq(0).html(gradPercent + "%");
      stats.eq(1).html(bachelorPercent + "%");
      stats.eq(2).html(hsPercent + "%");
      $('.typeahead').val(d.properties.name);

  }


  //
  //
  //=======

  jQuery.fn.d3Click = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

  //Change the map for different series
  //
  //==========
  function changeSeries(_series) {
    series = _series;

    var binNumber = 60;
    var dataHistogram = d3.layout.histogram()
      .value(function(d) {return d.properties[series];})
      .bins(binNumber)
      (data);

    data.map(function(d) {
      d.properties.bin = binIndex(d, dataHistogram);
    });

    histHeightScale = d3.scale.linear()
        .domain([0, 500])
        .range([0, histHeight-40]);

    histWidthScale = d3.scale.linear()
        .domain(d3.extent(data, function(d) { return d.properties[series]}))
        .range([0, histWidth]);

    data.map(function(d) {
      if(d.properties.name == currentData.properties.name) {
        currentData = d;
      }
    })
    $.proxy(refreshMap(currentData), currentContext);

    histogramJoin
      .data(dataHistogram)
        .transition().duration(500)
          .attr('height', function(d) {
            if(d.y != 0) {
              return histHeightScale(d.y)+1;
            } else {
              return histHeightScale(d.y);
            }
          })
          .attr('y', function(d) {
            if(d.y != 0) {
              return histHeight-40 - histHeightScale(d.y)-1;
            } else {
              return histHeight-40 - histHeightScale(d.y);
            }
          })
          .style("fill", function(d, i) {
            var returnVal = "";
            if(i < currentBin) {
              returnVal = green;
            } else if ( i > currentBin) {
              returnVal = red;
            } else {
              returnVal = "black";
            }
            return returnVal;
          });

      d3.select('.axes').selectAll('text')
        .data(d3.extent(data, function(d) {return d.properties[series]; }))
            .text(function(d) { return d + "%";});


      $('.stats').find('.stat').removeClass('featured');
      var divToHighlight = 0;
      if(series == "graduatePercent") divToHighlight = 0;
      if(series == "bachelorPercent") divToHighlight = 1;
      if(series == "hsPercent") divToHighlight = 2;
      $('.stats').eq(0).find('.stat').eq(divToHighlight).addClass('featured');
      $('.stats').eq(1).find('.stat').eq(divToHighlight).addClass('featured');


  }




</script>
